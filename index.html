<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestion des ClÃ©s - Agence ImmobiliÃ¨re</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="dashboard-modern.css">
    <link rel="stylesheet" href="modal-remise-details.css">
    <link rel="stylesheet" href="remises-search-styles.css">
    <link rel="stylesheet" href="filters-modern-styles.css">
    <link rel="stylesheet" href="header-modern-styles.css">
</head>
<body>
    <div class="container">
        <!-- Page de sÃ©lection d'Ã©quipe -->
        <div id="team-selection" class="page active">
            <div class="header">
                <h1>ğŸ”‘ Gestion des ClÃ©s</h1>
            </div>
            
            <!-- Barre de recherche rapide (plus compacte) -->
            <div class="quick-search-section compact">
                <div class="quick-search-bar">
                    <input type="text" id="quick-search-input" placeholder="ğŸ” Rechercher une clÃ© par nom, entreprise, ex-locataire, adresse...">
                </div>
                <div id="quick-search-results" class="quick-search-results"></div>
            </div>
            
            <!-- Bulles des Ã©quipes -->
            <div class="team-cards">
                <div class="team-card" onclick="selectTeam('travaux')">
                    <div class="team-icon">ğŸ”¨</div>
                    <h2>Travaux</h2>
                </div>
                <div class="team-card" onclick="selectTeam('commercialisation')">
                    <div class="team-icon">ğŸ¢</div>
                    <h2>Commercialisation</h2>
                </div>
                <div class="team-card" onclick="selectTeam('gestion')">
                    <div class="team-icon">ğŸ“‹</div>
                    <h2>Gestion</h2>
                </div>
            </div>

            <!-- Boutons d'accÃ¨s rapide -->
            <div class="quick-access-buttons">
                <button class="btn-quick-access" onclick="showHistoryFromHome()">
                    ğŸ“š Historique Complet
                </button>
                <button class="btn-quick-access" onclick="showPage('repertoire')">
                    ğŸ“‡ RÃ©pertoire de Contacts
                </button>
                <button class="btn-quick-access btn-remises-definitives" onclick="showRemisesHistoriqueFromHome()">
                    ğŸ“¦ ClÃ©s Parties DÃ©finitivement
                </button>
            </div>
            
            <!-- Tableau de bord gÃ©nÃ©ral -->
            <div class="global-dashboard">
                <h3>ğŸ“Š Vue d'Ensemble Globale</h3>
                <p class="dashboard-subtitle">Cliquez sur une carte pour voir les dÃ©tails</p>
                <div class="global-stats-grid">
                    <div class="global-stat-card clickable" onclick="showKeysListByCategory('all')">
                        <div class="global-stat-number" id="global-keys-out">0</div>
                        <div class="global-stat-label">ClÃ©s en circulation</div>
                        <div class="card-hint">ğŸ‘† Cliquer pour voir</div>
                    </div>
                    <div class="global-stat-card warning clickable" onclick="showKeysListByCategory('late1')">
                        <div class="global-stat-number" id="global-keys-late-1">0</div>
                        <div class="global-stat-label">Retard 1 jour</div>
                        <div class="card-hint">ğŸ‘† Cliquer pour voir</div>
                    </div>
                    <div class="global-stat-card alert clickable" onclick="showKeysListByCategory('late3')">
                        <div class="global-stat-number" id="global-keys-late-3">0</div>
                        <div class="global-stat-label">Retard 3+ jours</div>
                        <div class="card-hint">ğŸ‘† Cliquer pour voir</div>
                    </div>
                    <div class="global-stat-card critical clickable" onclick="showKeysListByCategory('late7')">
                        <div class="global-stat-number" id="global-keys-late-7">0</div>
                        <div class="global-stat-label">Retard 7+ jours</div>
                        <div class="card-hint">ğŸ‘† Cliquer pour voir</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Page de sÃ©lection d'utilisateur -->
        <div id="user-selection" class="page">
            <div class="header">
                <div class="header-buttons">
                    <button class="back-btn" onclick="goBack('team-selection')">â† Retour</button>
                    <button class="home-btn" onclick="showPage('team-selection')">ğŸ  Accueil</button>
                </div>
                <h1 id="team-name">Ã‰quipe</h1>
                <button class="settings-btn" onclick="showTeamSettings()">âš™ï¸ GÃ©rer</button>
            </div>
            
            <div id="user-buttons" class="user-grid"></div>
        </div>

        <!-- Page de gestion des profils -->
        <div id="team-settings" class="page">
            <div class="header">
                <div class="header-buttons">
                    <button class="back-btn" onclick="goBack('user-selection')">â† Retour</button>
                    <button class="home-btn" onclick="showPage('team-selection')">ğŸ  Accueil</button>
                </div>
                <h1>âš™ï¸ Gestion des Profils</h1>
                <p class="subtitle" id="settings-team-name">Ã‰quipe</p>
            </div>

            <div class="settings-container">
                <div class="settings-section">
                    <h3>â• Ajouter un Nouveau Profil</h3>
                    <div class="add-profile-form">
                        <input type="text" id="new-profile-name" placeholder="PrÃ©nom du nouveau membre..." maxlength="30">
                        <button class="btn btn-success" onclick="addNewProfile()">âœ… Ajouter</button>
                    </div>
                </div>

                <div class="settings-section">
                    <h3>ğŸ‘¥ Membres de l'Ã‰quipe</h3>
                    <div id="team-members-list" class="team-members-list"></div>
                </div>
            </div>
        </div>

        <!-- Tableau de bord principal -->
        <div id="dashboard" class="page">
            <!-- En-tÃªte modernisÃ© avec avatar et badge -->
            <div class="dashboard-header-modern">
                <div class="user-profile-card">
                    <div class="user-avatar">
                        <span class="avatar-icon">ğŸ‘¤</span>
                    </div>
                    <div class="user-details">
                        <h2 class="user-name" id="current-user"></h2>
                        <span class="user-team-badge" id="current-team-badge"></span>
                    </div>
                </div>
                <button class="logout-btn-modern" onclick="logout()">
                    <span class="logout-icon">ğŸšª</span>
                    <span>DÃ©connexion</span>
                </button>
            </div>

            <!-- Titre avec ligne dÃ©corative -->
            <div class="dashboard-title-section">
                <h1 class="dashboard-title">
                    <span class="title-icon">ğŸ“Š</span>
                    <span>Tableau de Bord</span>
                </h1>
                <p class="dashboard-subtitle">Vue d'ensemble de vos clÃ©s en circulation</p>
            </div>

            <!-- Statistiques modernisÃ©es avec icÃ´nes et gradients -->
            <div class="stats-grid-modern">
                <div class="stat-card-modern" onclick="showFilteredKeys('all')" data-stat-type="all">
                    <div class="stat-icon-container">
                        <span class="stat-icon">ğŸ”‘</span>
                    </div>
                    <div class="stat-content">
                        <div class="stat-number-modern" id="keys-out">0</div>
                        <div class="stat-label-modern">ClÃ©s en circulation</div>
                    </div>
                    <div class="stat-arrow">â†’</div>
                </div>
                
                <div class="stat-card-modern warning" onclick="showFilteredKeys('late-1')" data-stat-type="late-1">
                    <div class="stat-icon-container warning">
                        <span class="stat-icon">âš ï¸</span>
                    </div>
                    <div class="stat-content">
                        <div class="stat-number-modern" id="keys-late-1">0</div>
                        <div class="stat-label-modern">Retard 1 jour</div>
                    </div>
                    <div class="stat-arrow">â†’</div>
                </div>
                
                <div class="stat-card-modern alert" onclick="showFilteredKeys('late-3')" data-stat-type="late-3">
                    <div class="stat-icon-container alert">
                        <span class="stat-icon">ğŸ”´</span>
                    </div>
                    <div class="stat-content">
                        <div class="stat-number-modern" id="keys-late-3">0</div>
                        <div class="stat-label-modern">Retard 3+ jours</div>
                    </div>
                    <div class="stat-arrow">â†’</div>
                </div>
                
                <div class="stat-card-modern critical" onclick="showFilteredKeys('late-7')" data-stat-type="late-7">
                    <div class="stat-icon-container critical">
                        <span class="stat-icon">ğŸš¨</span>
                    </div>
                    <div class="stat-content">
                        <div class="stat-number-modern" id="keys-late-7">0</div>
                        <div class="stat-label-modern">Retard 7+ jours</div>
                    </div>
                    <div class="stat-arrow">â†’</div>
                </div>
            </div>

            <!-- ACTIONS PRINCIPALES (DÃ©part et Retour) -->
            <div class="dashboard-section">
                <h3 class="section-title-main">
                    <span class="section-icon">âš¡</span>
                    <span>Actions Principales</span>
                </h3>
                <div class="primary-actions-grid">
                    <button class="action-btn-large primary" onclick="showPage('depart-cles')">
                        <div class="action-btn-icon-large">ğŸ“¤</div>
                        <div class="action-btn-content-large">
                            <div class="action-btn-title-large">DÃ©part de ClÃ©s</div>
                            <div class="action-btn-desc-large">Enregistrer une nouvelle sortie de clÃ©s</div>
                        </div>
                        <div class="action-arrow-large">â†’</div>
                    </button>
                    
                    <button class="action-btn-large success" onclick="showPage('retour-cles')">
                        <div class="action-btn-icon-large">ğŸ“¥</div>
                        <div class="action-btn-content-large">
                            <div class="action-btn-title-large">Retour de ClÃ©s</div>
                            <div class="action-btn-desc-large">Enregistrer le retour de clÃ©s</div>
                        </div>
                        <div class="action-arrow-large">â†’</div>
                    </button>
                    
                    <button class="action-btn-large definitif" onclick="showPage('remise-definitive')">
                        <div class="action-btn-icon-large">ğŸ“‹</div>
                        <div class="action-btn-content-large">
                            <div class="action-btn-title-large">Remise DÃ©finitive</div>
                            <div class="action-btn-desc-large">EDL & Prestataires <span id="brouillons-badge" class="brouillons-badge"></span></div>
                        </div>
                        <div class="action-arrow-large">â†’</div>
                    </button>
                </div>
            </div>

            <!-- AUTRES ACTIONS (Liste, Historique, RÃ©pertoire) -->
            <div class="dashboard-section">
                <h3 class="section-title-secondary">
                    <span class="section-icon">ğŸ“‚</span>
                    <span>Autres Actions</span>
                </h3>
                <div class="secondary-actions-grid">
                    <button class="action-btn-small info" onclick="showPage('liste-cles')">
                        <div class="action-btn-icon-small">ğŸ“‹</div>
                        <div class="action-btn-content-small">
                            <div class="action-btn-title-small">Liste des ClÃ©s</div>
                        </div>
                    </button>
                    
                    <button class="action-btn-small secondary" onclick="showPage('historique')">
                        <div class="action-btn-icon-small">ğŸ“š</div>
                        <div class="action-btn-content-small">
                            <div class="action-btn-title-small">Historique</div>
                        </div>
                    </button>
                    
                    <button class="action-btn-small repertoire" onclick="showPage('repertoire')">
                        <div class="action-btn-icon-small">ğŸ“‡</div>
                        <div class="action-btn-content-small">
                            <div class="action-btn-title-small">RÃ©pertoire</div>
                        </div>
                    </button>
                </div>
            </div>
        </div>

        <!-- Page DÃ©part de ClÃ©s -->
        <div id="depart-cles" class="page">
            <div class="header">
                <div class="header-buttons">
                    <button class="back-btn" onclick="goBack('dashboard')">â† Retour</button>
                    <button class="home-btn" onclick="showPage('team-selection')">ğŸ  Accueil</button>
                </div>
                <h1>ğŸ“¤ DÃ©part de ClÃ©s</h1>
            </div>

            <form id="depart-form" class="form-container">
                <h3>Informations de la personne</h3>
                
                <!-- Recherche dans le rÃ©pertoire -->
                <div class="form-group">
                    <label>ğŸ” Recherche rapide dans le rÃ©pertoire</label>
                    <div class="autocomplete-container">
                        <input type="text" 
                               id="contact-search-depart" 
                               class="form-control" 
                               placeholder="Tapez un nom, prÃ©nom ou entreprise..."
                               autocomplete="off">
                        <button type="button" class="btn-repertoire-icon" onclick="showPage('repertoire')" title="Ouvrir le rÃ©pertoire">
                            ğŸ“‡
                        </button>
                        <div id="autocomplete-suggestions-depart" class="suggestions-dropdown"></div>
                    </div>
                </div>

                <div class="form-separator">
                    <span>OU remplir manuellement</span>
                </div>
                
                <div class="form-group">
                    <label>Nom *</label>
                    <input type="text" id="nom" required>
                </div>

                <div class="form-group">
                    <label>PrÃ©nom *</label>
                    <input type="text" id="prenom" required>
                </div>

                <div class="form-group">
                    <label>Nom de l'entreprise</label>
                    <input type="text" id="entreprise">
                </div>

                <div class="form-group">
                    <label>TÃ©lÃ©phone *</label>
                    <input type="tel" id="telephone" required>
                </div>

                <div class="form-group">
                    <label>Email *</label>
                    <input type="email" id="email" required>
                </div>

                <!-- Bouton enregistrer dans le rÃ©pertoire -->
                <div class="repertoire-action">
                    <div class="repertoire-info">
                        <span class="info-icon">ğŸ’¡</span>
                        <span class="info-text">Personne rÃ©guliÃ¨re ? Enregistrez-la dans le rÃ©pertoire pour gagner du temps !</span>
                    </div>
                    <button type="button" 
                            id="btn-save-to-repertoire-depart" 
                            class="btn-repertoire-save"
                            onclick="saveCurrentContactToRepertoire('depart')">
                        <span class="btn-icon">ğŸ“‡</span>
                        <span class="btn-text">Enregistrer dans le rÃ©pertoire</span>
                    </button>
                    <div id="repertoire-status-depart" class="repertoire-status"></div>
                </div>

                <h3>Informations du bien</h3>

                <div class="form-group">
                    <label>Nom de l'ex-locataire *</label>
                    <input type="text" id="ex-locataire" required>
                </div>

                <div class="form-group">
                    <label>Adresse du bien *</label>
                    <input type="text" id="adresse-bien" required>
                </div>

                <div class="form-group">
                    <label>NumÃ©ro de rÃ©fÃ©rence / Lot</label>
                    <input type="text" id="reference-lot">
                </div>

                <div class="form-group">
                    <label>Date de retour prÃ©vue *</label>
                    <input type="date" id="date-retour" required>
                </div>

                <div class="form-group">
                    <label>Notes / Commentaires</label>
                    <textarea id="commentaires" rows="3"></textarea>
                </div>

                <h3>âœï¸ Signature de la personne</h3>
                
                <div class="signature-section">
                    <p class="signature-instruction">Signez dans le cadre ci-dessous avec votre doigt (tactile) ou votre souris :</p>
                    <div class="signature-container">
                        <canvas id="signature-canvas-depart" class="signature-canvas"></canvas>
                    </div>
                    <div class="signature-buttons">
                        <button type="button" class="btn btn-secondary" onclick="clearSignature('depart')">
                            ğŸ—‘ï¸ Effacer
                        </button>
                    </div>
                    <p class="signature-required-note">* La signature est obligatoire</p>
                </div>

                <h3>Photo des clÃ©s</h3>
                
                <div class="photo-section">
                    <video id="video" autoplay playsinline webkit-playsinline></video>
                    <canvas id="canvas" style="display:none;"></canvas>
                    <img id="photo-preview" style="display:none;">
                    
                    <div class="photo-buttons">
                        <button type="button" class="btn btn-info" id="start-camera" onclick="startCamera()">
                            ğŸ“· DÃ©marrer la camÃ©ra
                        </button>
                        <button type="button" class="btn btn-warning" id="take-photo" onclick="takePhoto()" style="display:none;">
                            ğŸ“¸ Prendre la photo
                        </button>
                        <button type="button" class="btn btn-secondary" id="retake-photo" onclick="retakePhoto()" style="display:none;">
                            ğŸ”„ Reprendre
                        </button>
                    </div>
                </div>

                <button type="submit" class="btn btn-primary btn-large">
                    âœ… Enregistrer le dÃ©part
                </button>
            </form>
        </div>

        <!-- Page Retour de ClÃ©s -->
        <div id="retour-cles" class="page">
            <div class="header">
                <div class="header-buttons">
                    <button class="back-btn" onclick="goBack('dashboard')">â† Retour</button>
                    <button class="home-btn" onclick="showPage('team-selection')">ğŸ  Accueil</button>
                </div>
                <h1>ğŸ“¥ Retour de ClÃ©s</h1>
            </div>

            <div class="search-section">
                <h3>Rechercher le dossier</h3>
                
                <div class="form-group">
                    <label>Rechercher par nom/prÃ©nom</label>
                    <input type="text" id="search-nom" placeholder="Nom ou prÃ©nom...">
                </div>

                <div class="form-group">
                    <label>Rechercher par entreprise</label>
                    <input type="text" id="search-entreprise" placeholder="Nom de l'entreprise...">
                </div>

                <div class="form-group">
                    <label>Rechercher par ex-locataire</label>
                    <input type="text" id="search-locataire" placeholder="Nom de l'ex-locataire...">
                </div>

                <button class="btn btn-info" onclick="searchKeys()">ğŸ” Rechercher</button>
            </div>

            <div id="search-results" class="search-results"></div>
            
            <!-- Liste de toutes les clÃ©s en circulation -->
            <div class="all-keys-circulation-section">
                <h3>ğŸ“‹ Toutes les clÃ©s en circulation</h3>
                <div id="all-keys-circulation-list" class="history-list"></div>
            </div>
        </div>

        <!-- Page Liste des ClÃ©s Sorties -->
        <div id="liste-cles" class="page">
            <div class="header">
                <div class="header-buttons">
                    <button class="back-btn" onclick="goBack('dashboard')">â† Retour</button>
                    <button class="home-btn" onclick="showPage('team-selection')">ğŸ  Accueil</button>
                </div>
                <h1>ğŸ“‹ Liste des ClÃ©s Sorties</h1>
            </div>

            <div class="filter-section-advanced">
                <h3>ğŸ” Filtrer les clÃ©s sorties</h3>
                
                <div class="filter-row">
                    <div class="filter-item-wide">
                        <label for="filter-keys-type">Rechercher par</label>
                        <select id="filter-keys-type" class="form-control" onchange="updateFilterFieldKeys()">
                            <option value="">-- Choisir un critÃ¨re --</option>
                            <option value="person">ğŸ‘¤ Personne qui a pris les clÃ©s</option>
                            <option value="entreprise">ğŸ¢ Entreprise</option>
                            <option value="ex-locataire">ğŸ  Ex-locataire</option>
                            <option value="adresse">ğŸ“ Adresse du bien</option>
                        </select>
                    </div>
                    
                    <div class="filter-item-wide" id="filter-keys-text-container" style="display: none;">
                        <label for="filter-keys-text-value">Valeur</label>
                        <input type="text" id="filter-keys-text-value" class="form-control" placeholder="Saisir le texte Ã  rechercher...">
                    </div>
                </div>
                
                <div class="filter-row">
                    <div class="filter-item">
                        <label for="filter-keys-date-type">Filtrer par date</label>
                        <select id="filter-keys-date-type" class="form-control" onchange="updateDateFieldsKeys()">
                            <option value="">-- Aucun filtre de date --</option>
                            <option value="depart">ğŸ“… Date de dÃ©part</option>
                            <option value="return-expected">ğŸ“… Date de retour prÃ©vue</option>
                        </select>
                    </div>
                    
                    <div class="filter-item" id="filter-keys-date-start-container" style="display: none;">
                        <label for="filter-keys-date-start">Du</label>
                        <input type="date" id="filter-keys-date-start" class="form-control">
                    </div>
                    
                    <div class="filter-item" id="filter-keys-date-end-container" style="display: none;">
                        <label for="filter-keys-date-end">Au</label>
                        <input type="date" id="filter-keys-date-end" class="form-control">
                    </div>
                </div>
                
                <div class="filter-row">
                    <div class="filter-item">
                        <label for="filter-keys-status">Statut</label>
                        <select id="filter-keys-status" class="form-control">
                            <option value="">-- Tous --</option>
                            <option value="ok">âœ… Dans les temps</option>
                            <option value="late1">ğŸŸ  Retard 1 jour</option>
                            <option value="late3">ğŸ”´ Retard 3+ jours</option>
                            <option value="late7">ğŸ”´âš¡ Retard 7+ jours</option>
                        </select>
                    </div>
                </div>
                
                <div class="filter-actions">
                    <button class="btn btn-info" onclick="filterKeysList()">ğŸ” Filtrer</button>
                    <button class="btn btn-secondary" onclick="clearFiltersKeysList()">ğŸ”„ RÃ©initialiser</button>
                </div>
            </div>

            <div id="keys-list" class="keys-list"></div>
        </div>

        <!-- Page Historique -->
        <div id="historique" class="page">
            <div class="header">
                <div class="header-buttons">
                    <button class="back-btn" onclick="goBack('dashboard')">â† Retour</button>
                    <button class="home-btn" onclick="showPage('team-selection')">ğŸ  Accueil</button>
                </div>
                <h1>ğŸ“š Historique</h1>
            </div>

            <div class="filter-section-advanced">
                <h3>ğŸ” Filtrer l'historique</h3>
                
                <div class="filter-row">
                    <div class="filter-item-wide">
                        <label for="filter-type">Rechercher par</label>
                        <select id="filter-type" class="form-control" onchange="updateFilterField()">
                            <option value="">-- Choisir un critÃ¨re --</option>
                            <option value="person">ğŸ‘¤ Personne qui a pris les clÃ©s</option>
                            <option value="entreprise">ğŸ¢ Entreprise</option>
                            <option value="ex-locataire">ğŸ  Ex-locataire</option>
                            <option value="adresse">ğŸ“ Adresse du bien</option>
                            <option value="returned-person">ğŸ”„ Personne qui a ramenÃ©</option>
                            <option value="receptionnaire">ğŸ¯ RÃ©ceptionnÃ© par</option>
                        </select>
                    </div>
                    
                    <div class="filter-item-wide" id="filter-text-container" style="display: none;">
                        <label for="filter-text-value">Valeur</label>
                        <input type="text" id="filter-text-value" class="form-control" placeholder="Saisir le texte Ã  rechercher...">
                    </div>
                </div>
                
                <div class="filter-row">
                    <div class="filter-item">
                        <label for="filter-date-type">Filtrer par date</label>
                        <select id="filter-date-type" class="form-control" onchange="updateDateFields()">
                            <option value="">-- Aucun filtre de date --</option>
                            <option value="depart">ğŸ“… Date de dÃ©part</option>
                            <option value="return">ğŸ“… Date de retour</option>
                        </select>
                    </div>
                    
                    <div class="filter-item" id="filter-date-start-container" style="display: none;">
                        <label for="filter-date-start">Du</label>
                        <input type="date" id="filter-date-start" class="form-control">
                    </div>
                    
                    <div class="filter-item" id="filter-date-end-container" style="display: none;">
                        <label for="filter-date-end">Au</label>
                        <input type="date" id="filter-date-end" class="form-control">
                    </div>
                </div>
                
                <div class="filter-actions">
                    <button class="btn btn-info" onclick="filterHistoriqueAdvanced()">ğŸ” Filtrer</button>
                    <button class="btn btn-secondary" onclick="clearFiltersHistorique()">ğŸ”„ RÃ©initialiser</button>
                </div>
            </div>

            <div id="historique-list" class="historique-list"></div>
        </div>

        <!-- Page RÃ©pertoire -->
        <div id="repertoire" class="page">
            <div class="header">
                <div class="header-buttons">
                    <button class="back-btn" onclick="goBack('dashboard')">â† Retour</button>
                    <button class="home-btn" onclick="showPage('team-selection')">ğŸ  Accueil</button>
                </div>
                <h1>ğŸ“‡ RÃ©pertoire des Contacts</h1>
            </div>

            <div class="repertoire-header">
                <div class="repertoire-search-bar">
                    <input type="text" 
                           id="repertoire-search" 
                           class="form-control" 
                           placeholder="ğŸ” Rechercher un contact (nom, prÃ©nom, entreprise, tÃ©lÃ©phone, email)..."
                           oninput="searchRepertoire()">
                </div>
                <button class="btn btn-primary" onclick="openAddContactModal()">
                    â• Ajouter un contact
                </button>
            </div>

            <div class="repertoire-stats">
                <span id="repertoire-count">0 contact</span>
            </div>

            <div id="repertoire-list" class="repertoire-list">
                <!-- Les contacts seront affichÃ©s ici -->
            </div>
        </div>

        <!-- Page Remise DÃ©finitive -->
        <div id="remise-definitive" class="page">
            <div class="header">
                <div class="header-buttons">
                    <button class="back-btn" onclick="goBack('dashboard')">â† Retour</button>
                    <button class="home-btn" onclick="showPage('team-selection')">ğŸ  Accueil</button>
                </div>
                <h1>ğŸ“‹ Remise DÃ©finitive de ClÃ©s</h1>
            </div>

            <!-- Navigation Brouillons / Nouveau -->
            <div class="remise-nav">
                <button class="btn btn-info" onclick="showBrouillonsList()">
                    ğŸ“ Mes Brouillons (<span id="brouillons-count">0</span>)
                </button>
                <button class="btn btn-primary" onclick="showRemiseForm('new')">
                    â• Nouvelle Remise
                </button>
                <button class="btn btn-secondary" onclick="showRemisesHistorique()">
                    ğŸ“š Historique
                </button>
            </div>

            <!-- Liste des Brouillons -->
            <div id="brouillons-list-view" class="brouillons-container" style="display: none;">
                <h2>ğŸ“ Brouillons en Attente</h2>
                <div id="brouillons-list">
                    <!-- Liste des brouillons -->
                </div>
            </div>

            <!-- Formulaire de Remise DÃ©finitive -->
            <div id="remise-form-container" class="form-container" style="display: none;">
                <form id="remise-definitive-form">
                    <input type="hidden" id="remise-id">
                    <input type="hidden" id="remise-is-draft">

                    <h3>ğŸ‘¤ Informations du Prestataire / Agent EDL</h3>
                    
                    <!-- Recherche dans le rÃ©pertoire -->
                    <div class="form-group">
                        <label>ğŸ” Recherche rapide dans le rÃ©pertoire</label>
                        <div class="autocomplete-container">
                            <input type="text" 
                                   id="contact-search-remise" 
                                   class="form-control" 
                                   placeholder="Tapez un nom, prÃ©nom ou entreprise..."
                                   autocomplete="off">
                            <button type="button" class="btn-repertoire-icon" onclick="showPage('repertoire')" title="Ouvrir le rÃ©pertoire">
                                ğŸ“‡
                            </button>
                            <div id="autocomplete-suggestions-remise" class="suggestions-dropdown"></div>
                        </div>
                    </div>

                    <div class="form-separator">
                        <span>OU remplir manuellement</span>
                    </div>
                    
                    <div class="form-group">
                        <label>Nom du prestataire *</label>
                        <input type="text" id="remise-nom" required>
                    </div>

                    <div class="form-group">
                        <label>PrÃ©nom *</label>
                        <input type="text" id="remise-prenom" required>
                    </div>

                    <div class="form-group">
                        <label>Nom de l'entreprise *</label>
                        <input type="text" id="remise-entreprise" required>
                    </div>

                    <div class="form-group">
                        <label>TÃ©lÃ©phone *</label>
                        <input type="tel" id="remise-telephone" required>
                    </div>

                    <div class="form-group">
                        <label>Email</label>
                        <input type="email" id="remise-email">
                    </div>

                    <!-- Bouton enregistrer dans le rÃ©pertoire -->
                    <div class="repertoire-action">
                        <div class="repertoire-info">
                            <span class="info-icon">ğŸ’¡</span>
                            <span class="info-text">Prestataire rÃ©gulier ? Enregistrez-le dans le rÃ©pertoire !</span>
                        </div>
                        <button type="button" 
                                id="btn-save-to-repertoire-remise" 
                                class="btn-repertoire-save"
                                onclick="saveCurrentContactToRepertoire('remise')">
                            <span class="btn-icon">ğŸ“‡</span>
                            <span class="btn-text">Enregistrer dans le rÃ©pertoire</span>
                        </button>
                        <div id="repertoire-status-remise" class="repertoire-status"></div>
                    </div>

                    <h3>ğŸ¢ Informations du Bien Immobilier</h3>

                    <div class="form-group">
                        <label>Adresse du bien *</label>
                        <input type="text" id="remise-adresse-bien" required placeholder="NumÃ©ro, rue, code postal, ville">
                    </div>

                    <div class="form-group">
                        <label>RÃ©fÃ©rence du lot / Dossier</label>
                        <input type="text" id="remise-reference-lot" placeholder="Ex: LOT-2024-123">
                    </div>

                    <div class="form-group">
                        <label>Nom de l'ex-locataire</label>
                        <input type="text" id="remise-ex-locataire">
                    </div>

                    <h3>ğŸ”‘ Ã‰lÃ©ments Remis</h3>

                    <div class="elements-remis-grid">
                        <div class="form-group">
                            <label>
                                <input type="checkbox" id="remise-cles-checkbox" onchange="toggleElementQuantity('cles')">
                                ğŸ”‘ ClÃ©s
                            </label>
                            <input type="number" id="remise-cles-qty" min="0" placeholder="QuantitÃ©" disabled>
                        </div>

                        <div class="form-group">
                            <label>
                                <input type="checkbox" id="remise-vigik-checkbox" onchange="toggleElementQuantity('vigik')">
                                ğŸ“± Vigik / Badge
                            </label>
                            <input type="number" id="remise-vigik-qty" min="0" placeholder="QuantitÃ©" disabled>
                        </div>

                        <div class="form-group">
                            <label>
                                <input type="checkbox" id="remise-telecommande-checkbox" onchange="toggleElementQuantity('telecommande')">
                                ğŸš— TÃ©lÃ©commandes Parking
                            </label>
                            <input type="number" id="remise-telecommande-qty" min="0" placeholder="QuantitÃ©" disabled>
                        </div>

                        <div class="form-group">
                            <label>
                                <input type="checkbox" id="remise-badge-checkbox" onchange="toggleElementQuantity('badge')">
                                ğŸ« Autres Badges
                            </label>
                            <input type="number" id="remise-badge-qty" min="0" placeholder="QuantitÃ©" disabled>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Autres Ã©lÃ©ments remis</label>
                        <textarea id="remise-autres-elements" rows="3" placeholder="Ex: BoÃ®te aux lettres, interphone, etc."></textarea>
                    </div>

                    <h3>ğŸ“· Photos des Ã‰lÃ©ments Remis</h3>

                    <div class="form-group">
                        <label>Photo des clÃ©s, vigik, tÃ©lÃ©commandes remis *</label>
                        <div class="photo-info">
                            <span class="info-icon">ğŸ’¡</span>
                            <span class="info-text">Prenez une photo de l'ensemble des Ã©lÃ©ments remis (clÃ©s, vigik, tÃ©lÃ©commandes, badges...)</span>
                        </div>
                        <div class="photo-section">
                            <input type="file" id="remise-photo-decharge" accept="image/*" capture="environment" style="display: none;">
                            <button type="button" class="btn btn-photo" onclick="document.getElementById('remise-photo-decharge').click()">
                                ğŸ“· Prendre Photo avec CamÃ©ra
                            </button>
                            <div id="remise-preview-decharge" class="photo-preview"></div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Photo supplÃ©mentaire (optionnelle)</label>
                        <div class="photo-info">
                            <span class="info-icon">ğŸ’¡</span>
                            <span class="info-text">Photo complÃ©mentaire si nÃ©cessaire (autre angle, dÃ©charge signÃ©e...)</span>
                        </div>
                        <div class="photo-section">
                            <input type="file" id="remise-photo-extra" accept="image/*" capture="environment" style="display: none;">
                            <button type="button" class="btn btn-photo" onclick="document.getElementById('remise-photo-extra').click()">
                                ğŸ“· Prendre Photo avec CamÃ©ra
                            </button>
                            <div id="remise-preview-extra" class="photo-preview"></div>
                        </div>
                    </div>

                    <h3>âœï¸ Signature du Prestataire</h3>

                    <div class="form-group">
                        <label>Signature *</label>
                        <div class="signature-container">
                            <canvas id="signature-remise" class="signature-canvas"></canvas>
                            <button type="button" class="btn btn-secondary btn-clear-signature" onclick="clearSignatureRemise()">
                                ğŸ—‘ï¸ Effacer
                            </button>
                        </div>
                    </div>

                    <h3>ğŸ“ Informations ComplÃ©mentaires</h3>

                    <div class="form-group">
                        <label>Date et heure de remise *</label>
                        <input type="datetime-local" id="remise-date" required>
                    </div>

                    <div class="form-group">
                        <label>Commentaires</label>
                        <textarea id="remise-commentaires" rows="4" placeholder="Remarques, observations, dÃ©tails particuliers..."></textarea>
                    </div>

                    <!-- Boutons d'action -->
                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary" onclick="goBack('dashboard')">
                            âœ• Annuler
                        </button>
                        <button type="button" class="btn btn-warning" onclick="saveBrouillon()">
                            ğŸ’¾ Enregistrer en Brouillon
                        </button>
                        <button type="submit" class="btn btn-success btn-large">
                            âœ… Valider DÃ©finitivement
                        </button>
                    </div>
                </form>
            </div>

            <!-- Historique des Remises DÃ©finitives -->
            <div id="remises-historique-view" class="historique-container" style="display: none;">
                <h2>ğŸ“š Historique des Remises DÃ©finitives</h2>
                
                <div class="remises-search-container">
                    <div class="search-box-modern">
                        <span class="search-icon">ğŸ”</span>
                        <input type="text" id="remises-search" class="search-input-modern" placeholder="Rechercher par adresse, prestataire, entreprise ou rÃ©fÃ©rence...">
                    </div>
                    
                    <div class="filter-box-modern">
                        <span class="filter-icon">ğŸ‘¤</span>
                        <select id="remises-filter-user" class="filter-select-modern">
                            <option value="all">ğŸ“‹ Tous les profils</option>
                            <option value="current">ğŸ‘¤ Mon profil uniquement</option>
                        </select>
                    </div>
                </div>

                <div id="remises-historique-list">
                    <!-- Liste des remises dÃ©finitives -->
                </div>
            </div>
        </div>

        <!-- Modal de confirmation de retour -->
        <div id="modal-retour" class="modal">
            <div class="modal-content">
                <h2>Confirmer le retour des clÃ©s</h2>
                <div id="modal-details"></div>
                <div class="modal-buttons">
                    <button class="btn btn-secondary" onclick="closeModal()">Annuler</button>
                    <button class="btn btn-success" onclick="confirmReturn()">âœ… Confirmer le retour</button>
                </div>
            </div>
        </div>

        <!-- Modal de modification de date de retour -->
        <div id="modal-edit-date" class="modal">
            <div class="modal-content">
                <h2>ğŸ“… Modifier la Date de Retour</h2>
                <div id="edit-date-details" class="edit-date-section">
                    <div class="form-group">
                        <label>Date de retour actuelle :</label>
                        <div id="current-return-date" class="current-date-display"></div>
                    </div>
                    <div class="form-group">
                        <label>Nouvelle date de retour :</label>
                        <input type="datetime-local" id="new-return-date" class="date-input">
                    </div>
                </div>
                <div class="modal-buttons">
                    <button class="btn btn-secondary" onclick="closeEditDateModal()">Annuler</button>
                    <button class="btn btn-primary" onclick="saveNewReturnDate()">âœ… Enregistrer</button>
                </div>
            </div>
        </div>

        <!-- Modal d'affichage des clÃ©s par catÃ©gorie -->
        <div id="modal-keys-list" class="modal">
            <div class="modal-content modal-large">
                <div class="modal-header">
                    <h2 id="modal-keys-title">ğŸ“‹ Liste des ClÃ©s</h2>
                    <button class="modal-close-btn" onclick="closeKeysListModal()">âœ•</button>
                </div>
                <div id="modal-keys-content" class="modal-keys-content">
                    <!-- Contenu dynamique -->
                </div>
                <div class="modal-buttons">
                    <button class="btn btn-secondary" onclick="closeKeysListModal()">Fermer</button>
                </div>
            </div>
        </div>

        <!-- Modal de validation de retour rapide -->
        <div id="modal-quick-return" class="modal">
            <div class="modal-content">
                <h2>âœ… Validation du Retour de ClÃ©</h2>
                
                <div id="quick-return-key-info" class="return-key-summary">
                    <!-- RÃ©sumÃ© de la clÃ© affichÃ© ici -->
                </div>

                <div class="return-form">
                    <h3>ğŸ‘¤ Personne qui ramÃ¨ne les clÃ©s</h3>
                    
                    <!-- Recherche dans le rÃ©pertoire -->
                    <div class="form-group">
                        <label>ğŸ” Recherche rapide dans le rÃ©pertoire</label>
                        <div class="autocomplete-container">
                            <input type="text" 
                                   id="contact-search-return" 
                                   class="form-control" 
                                   placeholder="Tapez un nom, prÃ©nom ou entreprise..."
                                   autocomplete="off">
                            <button type="button" class="btn-repertoire-icon" onclick="showPage('repertoire'); closeQuickReturnModal();" title="Ouvrir le rÃ©pertoire">
                                ğŸ“‡
                            </button>
                            <div id="autocomplete-suggestions-return" class="suggestions-dropdown"></div>
                        </div>
                    </div>

                    <div class="form-separator">
                        <span>OU remplir manuellement</span>
                    </div>
                    
                    <div class="form-group">
                        <label for="return-person-nom">Nom *</label>
                        <input type="text" id="return-person-nom" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="return-person-prenom">PrÃ©nom *</label>
                        <input type="text" id="return-person-prenom" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="return-person-telephone">TÃ©lÃ©phone *</label>
                        <input type="tel" id="return-person-telephone" class="form-control" required>
                    </div>

                    <!-- Bouton enregistrer dans le rÃ©pertoire -->
                    <div class="repertoire-action">
                        <div class="repertoire-info">
                            <span class="info-icon">ğŸ’¡</span>
                            <span class="info-text">Personne rÃ©guliÃ¨re ? Enregistrez-la !</span>
                        </div>
                        <button type="button" 
                                id="btn-save-to-repertoire-return" 
                                class="btn-repertoire-save"
                                onclick="saveCurrentContactToRepertoire('return')">
                            <span class="btn-icon">ğŸ“‡</span>
                            <span class="btn-text">Enregistrer dans le rÃ©pertoire</span>
                        </button>
                        <div id="repertoire-status-return" class="repertoire-status"></div>
                    </div>

                    <h3>ğŸ¯ RÃ©ceptionnaire</h3>
                    <div class="form-group">
                        <label for="return-receptionnaire-team">Ã‰quipe *</label>
                        <select id="return-receptionnaire-team" class="form-control" onchange="loadReceptionnaireMembers()">
                            <option value="">-- SÃ©lectionner une Ã©quipe --</option>
                            <option value="travaux">ğŸ”¨ Travaux</option>
                            <option value="commercialisation">ğŸ¢ Commercialisation</option>
                            <option value="gestion">ğŸ“‹ Gestion</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="return-receptionnaire-name">Membre de l'Ã©quipe *</label>
                        <select id="return-receptionnaire-name" class="form-control" disabled>
                            <option value="">-- D'abord choisir une Ã©quipe --</option>
                        </select>
                    </div>

                    <h3>ğŸ“¸ Photo des clÃ©s rendues (obligatoire)</h3>
                    <div class="photo-section-required">
                        <p class="photo-instruction">Prenez une photo des clÃ©s pour vÃ©rifier la correspondance avec les clÃ©s donnÃ©es initialement :</p>
                        <div class="photo-controls">
                            <button type="button" id="start-camera-return-complete" class="btn btn-primary" onclick="startCameraReturnComplete()">
                                ğŸ“· DÃ©marrer la camÃ©ra
                            </button>
                            <video id="video-return-complete" class="photo-preview" autoplay playsinline webkit-playsinline style="display: none;"></video>
                            <button type="button" id="take-photo-return-complete" class="btn btn-success" onclick="takePhotoReturnComplete()" style="display: none;">
                                ğŸ“¸ Prendre la photo
                            </button>
                            <canvas id="canvas-return-complete" style="display: none;"></canvas>
                            <img id="photo-preview-return-complete" class="photo-preview" style="display: none;">
                            <button type="button" id="retake-photo-return-complete" class="btn btn-secondary" onclick="retakePhotoReturnComplete()" style="display: none;">
                                ğŸ”„ Reprendre la photo
                            </button>
                        </div>
                        <p class="photo-required-note">* La photo est obligatoire pour tous les retours</p>
                    </div>

                    <h3>âœï¸ Signature de la personne qui ramÃ¨ne</h3>
                    <div class="signature-section">
                        <p class="signature-instruction">Signez dans le cadre ci-dessous :</p>
                        <div class="signature-container">
                            <canvas id="signature-canvas-return" class="signature-canvas"></canvas>
                        </div>
                        <div class="signature-buttons">
                            <button type="button" class="btn btn-secondary" onclick="clearSignature('return')">
                                ğŸ—‘ï¸ Effacer
                            </button>
                        </div>
                        <p class="signature-required-note">* La signature est obligatoire</p>
                    </div>

                    <!-- Section clÃ©s manquantes -->
                    <h3>âš ï¸ VÃ©rification des clÃ©s</h3>
                    <div class="missing-keys-section">
                        <div class="form-group">
                            <label class="checkbox-label">
                                <input type="checkbox" id="return-missing-keys-checkbox" onchange="toggleMissingKeysSection()">
                                <span class="checkbox-text">âŒ Il manque des clÃ©s Ã  la restitution</span>
                            </label>
                        </div>

                        <div id="missing-keys-details" class="missing-keys-details" style="display: none;">
                            <div class="alert-warning">
                                âš ï¸ <strong>Attention :</strong> Si des clÃ©s manquent, la fiche restera dans "ClÃ©s en circulation"
                            </div>

                            <div class="form-group">
                                <label for="return-missing-keys-comment">Commentaire sur les clÃ©s manquantes *</label>
                                <textarea id="return-missing-keys-comment" class="form-control" rows="3" placeholder="DÃ©crivez quelles clÃ©s manquent et les raisons..."></textarea>
                            </div>

                            <div class="form-group">
                                <label>ğŸ“¸ Photo des clÃ©s rendues (pour comparaison) *</label>
                                <div class="photo-section">
                                    <button type="button" id="start-camera-return-partial" class="btn btn-primary" onclick="startCameraReturnPartial()">
                                        ğŸ“· DÃ©marrer la camÃ©ra
                                    </button>
                                    <video id="video-return-partial" class="photo-preview" autoplay playsinline webkit-playsinline style="display: none;"></video>
                                    <button type="button" id="take-photo-return-partial" class="btn btn-success" onclick="takePhotoReturnPartial()" style="display: none;">
                                        ğŸ“¸ Prendre la photo
                                    </button>
                                    <canvas id="canvas-return-partial" style="display: none;"></canvas>
                                    <img id="photo-preview-return-partial" class="photo-preview" style="display: none;">
                                    <button type="button" id="retake-photo-return-partial" class="btn btn-secondary" onclick="retakePhotoReturnPartial()" style="display: none;">
                                        ğŸ”„ Reprendre la photo
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="modal-buttons">
                    <button class="btn btn-secondary" onclick="closeQuickReturnModal()">Annuler</button>
                    <button class="btn btn-success" onclick="confirmQuickReturn()">âœ… Valider le Retour</button>
                </div>
            </div>
        </div>

        <!-- Modal Ajouter/Modifier Contact -->
        <div id="modal-contact" class="modal">
            <div class="modal-content">
                <h2 id="modal-contact-title">â• Ajouter un Contact</h2>
                
                <form id="contact-form" onsubmit="saveContactFromModal(event)">
                    <div class="form-group">
                        <label for="modal-contact-nom">Nom *</label>
                        <input type="text" id="modal-contact-nom" class="form-control" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="modal-contact-prenom">PrÃ©nom *</label>
                        <input type="text" id="modal-contact-prenom" class="form-control" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="modal-contact-entreprise">Entreprise</label>
                        <input type="text" id="modal-contact-entreprise" class="form-control">
                    </div>
                    
                    <div class="form-group">
                        <label for="modal-contact-telephone">TÃ©lÃ©phone *</label>
                        <input type="tel" id="modal-contact-telephone" class="form-control" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="modal-contact-email">Email</label>
                        <input type="email" id="modal-contact-email" class="form-control">
                    </div>
                    
                    <div class="form-group">
                        <label for="modal-contact-notes">Notes</label>
                        <textarea id="modal-contact-notes" class="form-control" rows="3"></textarea>
                    </div>
                    
                    <input type="hidden" id="modal-contact-id" value="">
                    
                    <div class="modal-buttons">
                        <button type="button" class="btn btn-secondary" onclick="closeContactModal()">Annuler</button>
                        <button type="submit" class="btn btn-primary">ğŸ’¾ Enregistrer</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script src="app.js"></script>
</body>
</html>
